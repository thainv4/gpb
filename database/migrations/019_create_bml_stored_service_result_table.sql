-- Migration: 019_create_bml_stored_service_result_table.sql
-- Description: Tạo bảng BML_STORED_SERVICE_RESULT để lưu kết quả xét nghiệm

-- Drop table if exists (for clean migration)
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE BML_STORED_SERVICE_RESULT CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -942 THEN
            RAISE;
        END IF;
END;
/

-- Create table
CREATE TABLE BML_STORED_SERVICE_RESULT (
    ID VARCHAR2(36) PRIMARY KEY,
    STORED_SR_SERVICE_ID VARCHAR2(36) NOT NULL,
    DOCUMENT_ID NUMBER,
    DESCRIPTION NVARCHAR2(2000),
    CONCLUDE NVARCHAR2(2000),
    NOTE NVARCHAR2(2000),
    
    -- Base Entity
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DELETED_AT TIMESTAMP NULL,
    CREATED_BY VARCHAR2(50),
    UPDATED_BY VARCHAR2(50),
    VERSION NUMBER DEFAULT 1,
    
    CONSTRAINT FK_SSR_RESULT_SERVICE FOREIGN KEY (STORED_SR_SERVICE_ID) 
        REFERENCES BML_STORED_SR_SERVICES(ID) ON DELETE CASCADE
);

-- Indexes
CREATE INDEX IDX_SSR_RESULT_SERVICE ON BML_STORED_SERVICE_RESULT(STORED_SR_SERVICE_ID);
CREATE INDEX IDX_SSR_RESULT_DOC ON BML_STORED_SERVICE_RESULT(DOCUMENT_ID);

-- Comments
COMMENT ON TABLE BML_STORED_SERVICE_RESULT IS 'Bảng lưu kết quả xét nghiệm';
COMMENT ON COLUMN BML_STORED_SERVICE_RESULT.ID IS 'ID kết quả (UUID)';
COMMENT ON COLUMN BML_STORED_SERVICE_RESULT.STORED_SR_SERVICE_ID IS 'ID dịch vụ trong BML_STORED_SR_SERVICES';
COMMENT ON COLUMN BML_STORED_SERVICE_RESULT.DOCUMENT_ID IS 'ID văn bản EMR (từ bảng EMR_DOCUMENT)';
COMMENT ON COLUMN BML_STORED_SERVICE_RESULT.DESCRIPTION IS 'Mô tả kết quả';
COMMENT ON COLUMN BML_STORED_SERVICE_RESULT.CONCLUDE IS 'Kết luận';
COMMENT ON COLUMN BML_STORED_SERVICE_RESULT.NOTE IS 'Ghi chú';

COMMIT;
